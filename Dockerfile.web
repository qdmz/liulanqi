FROM ubuntu:22.04

# 设置环境变量
ENV DEBIAN_FRONTEND=noninteractive
ENV DISPLAY=:99

# 安装必要依赖
RUN apt-get update && apt-get install -y \
    wget \
    gnupg \
    software-properties-common \
    xvfb \
    x11vnc \
    fluxbox \
    wmctrl \
    qtwebengine5-dev \
    qt5-qmake \
    libqt5webenginewidgets5 \
    libqt5webenginecore5 \
    fonts-wqy-microhei \
    fonts-wqy-zenhei \
    xdg-utils \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libxrender1 \
    libxrandr2 \
    libxss1 \
    libgtk-3-0 \
    libnss3 \
    libdrm2 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libasound2 \
    libatspi2.0-0 \
    libcairo-gobject2 \
    libdbus-1-3 \
    libgdk-pixbuf-2.0-0 \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    libpangoft2-1.0-0 \
    libx11-6 \
    libx11-xcb1 \
    libxcb1 \
    libxcursor1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxi6 \
    libxinerama1 \
    libxrender1 \
    libxtst6 \
    libatk-bridge2.0-0 \
    libatk1.0-0 \
    libcups2 \
    libdrm2 \
    libgbm1 \
    libxss1 \
    supervisor \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# 安装 noVNC
RUN git clone https://github.com/novnc/noVNC.git /opt/noVNC && \
    git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify && \
    ln -s /opt/noVNC/vnc.html /opt/noVNC/index.html

# 安装 Python3 websockify (替代旧的 Python2 版本)
RUN apt-get update && apt-get install -y python3-numpy && \
    rm -rf /var/lib/apt/lists/*

# 创建工作目录
WORKDIR /app

# 复制浏览器可执行文件
COPY build/simple-browser /app/simple-browser
COPY build/run_browser.sh /app/run_browser.sh

# 设置执行权限
RUN chmod +x /app/simple-browser
RUN chmod +x /app/run_browser.sh

# 创建配置文件目录
RUN mkdir -p /etc/supervisor/conf.d

# 创建supervisor配置文件
RUN echo "[supervisord]\n\
nodaemon=true\n\
user=root\n\
logfile=/var/log/supervisor/supervisord.log\n\
logfile_maxbytes=1MB\n\
logfile_backups=3\n\
loglevel=info\n\
pidfile=/var/run/supervisord.pid\n\
strip_ansi=true\n\
\n\
[program:xvfb]\n\
command=Xvfb :99 -screen 0 1024x768x24 -ac +extension GLX\n\
autostart=true\n\
autorestart=true\n\
stdout_logfile=/var/log/supervisor/xvfb.log\n\
stderr_logfile=/var/log/supervisor/xvfb.log\n\
\n\
[program:fluxbox]\n\
command=/usr/bin/fluxbox\n\
autostart=true\n\
autorestart=true\n\
environment=DISPLAY=:99\n\
stdout_logfile=/var/log/supervisor/fluxbox.log\n\
stderr_logfile=/var/log/supervisor/fluxbox.log\n\
\n\
[program:x11vnc]\n\
command=x11vnc -display :99 -listen 0.0.0.0 -xkb -forever -shared -bg -o /var/log/x11vnc.log -rfbport 5900\n\
autostart=true\n\
autorestart=true\n\
stdout_logfile=/var/log/supervisor/x11vnc.log\n\
stderr_logfile=/var/log/supervisor/x11vnc.log\n\
\n\
[program:novnc]\n\
command=/opt/noVNC/utils/websockify/websockify.py --web /opt/noVNC 6080 localhost:5900\n\
autostart=true\n\
autorestart=true\n\
stdout_logfile=/var/log/supervisor/novnc.log\n\
stderr_logfile=/var/log/supervisor/novnc.log\n\
\n\
[program:browser]\n\
command=/app/simple-browser --no-sandbox --disable-gpu --disable-software-rasterizer --disable-gpu-sandbox\n\
autostart=true\n\
autorestart=true\n\
environment=DISPLAY=:99\n\
stdout_logfile=/var/log/supervisor/browser.log\n\
stderr_logfile=/var/log/supervisor/browser.log" > /etc/supervisor/conf.d/supervisord.conf

# 暴露Web界面端口
EXPOSE 6080

# 启动脚本
RUN echo "#!/bin/bash\n\
service dbus start\n\
exec supervisord -c /etc/supervisor/conf.d/supervisord.conf" > /app/start.sh
RUN chmod +x /app/start.sh

# 启动命令
CMD ["/app/start.sh"]